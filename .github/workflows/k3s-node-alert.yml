name: k3s-node-alert

on:
  repository_dispatch:
    types: [k3s-node-alert]
  workflow_dispatch:
    inputs:
      payload_json:
        description: "Optional JSON payload for test runs"
        required: false
        default: ""

jobs:
  notify:
    runs-on: [self-hosted]
    steps:
      - name: Send email
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
          MAIL_TO: ${{ secrets.MAIL_TO }}
          PAYLOAD: ${{ toJson(github.event.client_payload) }}
          PAYLOAD_INPUT: ${{ github.event.inputs.payload_json }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import smtplib
          from email.message import EmailMessage

          payload = os.environ.get("PAYLOAD")
          if not payload or payload == "null":
              payload = os.environ.get("PAYLOAD_INPUT") or "{}"
          data = json.loads(payload)

          cluster = data.get("cluster", "")
          event = data.get("event", "test")
          status = data.get("status", "")
          nodes_down = data.get("nodes_down", "")
          nodes_down_current = data.get("nodes_down_current", "")
          nodes_recovered = data.get("nodes_recovered", "")
          timestamp = data.get("timestamp", "")
          nodes_table = data.get("nodes_table", "")

          if event == "resolved" or status == "node-recovered":
              alert_label = "RECOVERY"
              summary = f"Recovered nodes: {nodes_recovered or 'none'}"
          elif event == "incident" or status == "node-down":
              alert_label = "INCIDENT"
              summary = f"Newly down nodes: {nodes_down or 'none'}"
          else:
              alert_label = "CHANGE"
              summary = "Node state change detected"

          subject = f"[{alert_label}] k3s {cluster} - {status}"
          body = "\n".join(
              [
                  f"Cluster: {cluster}",
                  f"Alert Type: {alert_label}",
                  f"Event: {event}",
                  f"Status: {status}",
                  f"Summary: {summary}",
                  f"Down (new): {nodes_down}",
                  f"Down (current): {nodes_down_current}",
                  f"Recovered: {nodes_recovered}",
                  f"Time: {timestamp}",
                  "",
                  "Nodes:",
                  nodes_table,
              ]
          )

          msg = EmailMessage()
          msg["Subject"] = subject
          msg["From"] = os.environ["MAIL_FROM"]
          msg["To"] = os.environ["MAIL_TO"]
          msg.set_content(body)

          host = os.environ["SMTP_HOST"]
          port = int(os.environ["SMTP_PORT"])
          user = os.environ["SMTP_USER"]
          password = os.environ["SMTP_PASS"]

          with smtplib.SMTP_SSL(host, port) as smtp:
              smtp.login(user, password)
              smtp.send_message(msg)
          PY
