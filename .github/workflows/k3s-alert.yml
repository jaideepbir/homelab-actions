name: k3s-alert

on:
  repository_dispatch:
    types: [k3s-alert]
  workflow_dispatch:
    inputs:
      payload_json:
        description: "Optional JSON payload for test runs"
        required: false
        default: "{}"

permissions:
  contents: read

jobs:
  notify:
    runs-on: [self-hosted]
    steps:
      - name: Send ingress alert email
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
          MAIL_TO: ${{ secrets.MAIL_TO }}
          PAYLOAD: ${{ toJson(github.event.client_payload) }}
          PAYLOAD_INPUT: ${{ github.event.inputs.payload_json }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import smtplib
          from email.message import EmailMessage

          payload = os.environ.get("PAYLOAD")
          if not payload or payload == "null":
              payload = os.environ.get("PAYLOAD_INPUT") or "{}"
          data = json.loads(payload)

          cluster = data.get("cluster", "")
          event = data.get("event", "")
          status = data.get("status", "")
          summary = data.get("summary", "")
          timestamp = data.get("timestamp", "")

          subject = f"[INGRESS] k3s-alert {cluster} {status}".strip()
          body = "\n".join([
              "Event Type: k3s-alert",
              f"Cluster: {cluster}",
              f"Event: {event}",
              f"Status: {status}",
              f"Summary: {summary}",
              f"Time: {timestamp}",
              "",
              "Payload:",
              json.dumps(data, indent=2, sort_keys=True),
          ])

          msg = EmailMessage()
          msg["Subject"] = subject
          msg["From"] = os.environ["MAIL_FROM"]
          msg["To"] = os.environ["MAIL_TO"]
          msg.set_content(body)

          with smtplib.SMTP_SSL(os.environ["SMTP_HOST"], int(os.environ["SMTP_PORT"])) as smtp:
              smtp.login(os.environ["SMTP_USER"], os.environ["SMTP_PASS"])
              smtp.send_message(msg)
          PY

  forward-triage-router:
    runs-on: [self-hosted]
    needs: notify
    if: ${{ always() }}
    env:
      HAS_TRIAGE_APP_CREDS: ${{ secrets.K3S_OPS_APP_ID != '' && secrets.K3S_OPS_APP_PRIVATE_KEY != '' }}
    steps:
      - name: Mint triage dispatch token via GitHub App
        id: triage_app_token
        if: ${{ env.HAS_TRIAGE_APP_CREDS == 'true' }}
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.K3S_OPS_APP_ID }}
          private-key: ${{ secrets.K3S_OPS_APP_PRIVATE_KEY }}
          owner: Jmake-space
          repositories: k3s-cluster

      - name: Forward to triage-router-workflow
        env:
          PAYLOAD: ${{ toJson(github.event.client_payload) }}
          PAYLOAD_INPUT: ${{ github.event.inputs.payload_json }}
          TRIAGE_DISPATCH_URL: ${{ vars.TRIAGE_DISPATCH_URL || 'https://api.github.com/repos/Jmake-space/k3s-cluster/dispatches' }}
          TRIAGE_EVENT_TYPE: ${{ vars.TRIAGE_EVENT_TYPE || 'triage-router-workflow' }}
          TRIAGE_DISPATCH_TOKEN: ${{ steps.triage_app_token.outputs.token || secrets.K3S_OPS_REPO_DISPATCH_TOKEN }}
          SOURCE_REPO: ${{ github.repository }}
          SOURCE_WORKFLOW: ${{ github.workflow }}
          SOURCE_RUN_ID: ${{ github.run_id }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import sys
          import urllib.request

          token = (os.environ.get("TRIAGE_DISPATCH_TOKEN") or "").strip()
          dispatch_url = (os.environ.get("TRIAGE_DISPATCH_URL") or "").strip()
          dispatch_event_type = (os.environ.get("TRIAGE_EVENT_TYPE") or "triage-router-workflow").strip()
          payload_raw = os.environ.get("PAYLOAD")
          if not payload_raw or payload_raw == "null":
              payload_raw = os.environ.get("PAYLOAD_INPUT") or "{}"

          if not token or not dispatch_url:
              print("triage forward skipped: missing token or dispatch URL")
              sys.exit(0)

          payload = json.loads(payload_raw)
          payload["source"] = {
              "repo": os.environ.get("SOURCE_REPO", ""),
              "workflow": os.environ.get("SOURCE_WORKFLOW", ""),
              "run_id": os.environ.get("SOURCE_RUN_ID", ""),
          }

          body = {"event_type": dispatch_event_type, "client_payload": payload}

          request = urllib.request.Request(
              dispatch_url,
              data=json.dumps(body).encode("utf-8"),
              headers={
                  "Accept": "application/vnd.github+json",
                  "Authorization": f"token {token}",
                  "Content-Type": "application/json",
              },
              method="POST",
          )
          with urllib.request.urlopen(request, timeout=15) as response:
              print(f"triage-router dispatch forwarded: status={response.status}")
          PY
