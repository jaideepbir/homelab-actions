name: ops-agent-alerts

on:
  repository_dispatch:
    types:
      - k3s-ops-agent-alert
      - k3s-support-agent-alert
      - airflow-ops-agent-alert
      - cloudflare-agent-alert
      - immich-agent-alert
      - resume-ops-agent-alert
      - ghrunner-ops-agent-alert
      - wiki-ops-agent-alert
  workflow_dispatch:
    inputs:
      event_type:
        description: "Ops agent event type"
        required: false
        default: "k3s-ops-agent-alert"
      payload_json:
        description: "Optional JSON payload for test runs"
        required: false
        default: "{}"

permissions:
  contents: read

jobs:
  notify:
    runs-on: [self-hosted]
    steps:
      - name: Build and send ops-agent alert email
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
          MAIL_TO: ${{ secrets.MAIL_TO }}
          EVENT_TYPE: ${{ github.event.action }}
          EVENT_TYPE_INPUT: ${{ github.event.inputs.event_type }}
          PAYLOAD: ${{ toJson(github.event.client_payload) }}
          PAYLOAD_INPUT: ${{ github.event.inputs.payload_json }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import smtplib
          from email.message import EmailMessage

          event_type = (os.environ.get("EVENT_TYPE") or "").strip()
          if not event_type:
              event_type = (os.environ.get("EVENT_TYPE_INPUT") or "k3s-ops-agent-alert").strip()

          payload = os.environ.get("PAYLOAD")
          if not payload or payload == "null":
              payload = os.environ.get("PAYLOAD_INPUT") or "{}"
          data = json.loads(payload)

          cluster = data.get("cluster", "")
          event = data.get("event", "test")
          status = data.get("status", "")
          summary = data.get("summary", "")
          service = data.get("service", "")
          timestamp = data.get("timestamp", "")
          details = data.get("details", "")
          route_reason = data.get("route_reason", "")

          subject = f"[OPS-ALERT] {event_type} {cluster} {status}".strip()
          body = "\n".join(
              [
                  f"Event Type: {event_type}",
                  f"Cluster: {cluster}",
                  f"Event: {event}",
                  f"Status: {status}",
                  f"Service: {service}",
                  f"Summary: {summary}",
                  f"Route Reason: {route_reason}",
                  f"Time: {timestamp}",
                  "",
                  "Details:",
                  str(details),
                  "",
                  "Payload:",
                  json.dumps(data, indent=2, sort_keys=True),
              ]
          )

          msg = EmailMessage()
          msg["Subject"] = subject
          msg["From"] = os.environ["MAIL_FROM"]
          msg["To"] = os.environ["MAIL_TO"]
          msg.set_content(body)

          with smtplib.SMTP_SSL(os.environ["SMTP_HOST"], int(os.environ["SMTP_PORT"])) as smtp:
              smtp.login(os.environ["SMTP_USER"], os.environ["SMTP_PASS"])
              smtp.send_message(msg)
          PY
