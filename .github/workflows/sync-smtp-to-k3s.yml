name: Sync SMTP Secrets to K3s

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/sync-smtp-to-k3s.yml'

jobs:
  sync-secrets:
    runs-on: [self-hosted]
    steps:
      - name: Create/Update SMTP Secret in K3s
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
          MAIL_TO: ${{ secrets.MAIL_TO }}
          KUBECONFIG: /home/jaideepbir/k3s.yaml
        run: |
          set -e
          
          # Find kubectl location
          KUBECTL=$(which kubectl 2>/dev/null || find /usr -name kubectl -type f 2>/dev/null | head -1 || echo "kubectl")
          
          if ! command -v $KUBECTL &> /dev/null; then
            echo "Installing kubectl..."
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            KUBECTL=./kubectl
          fi
          
          echo "Using kubectl: $KUBECTL"
          echo "Using kubeconfig: $KUBECONFIG"
          
          # Create or update n8n-smtp secret in default namespace
          $KUBECTL create secret generic n8n-smtp \
            --from-literal=smtp-host="$SMTP_HOST" \
            --from-literal=smtp-port="$SMTP_PORT" \
            --from-literal=smtp-user="$SMTP_USER" \
            --from-literal=smtp-pass="$SMTP_PASS" \
            --from-literal=mail-from="$MAIL_FROM" \
            --from-literal=mail-to="$MAIL_TO" \
            --dry-run=client -o yaml | $KUBECTL apply -f -
          
          echo "âœ“ SMTP secrets synced to k3s"
          $KUBECTL get secret n8n-smtp -o jsonpath='{.data}' | jq 'keys'
